# Story 2.2: Beam Management

## Status

Draft

## Story

**As a** production supervisor,
**I want** to create and load beams on machines,
**so that** I can track warp preparation for weaving.

## Acceptance Criteria

1. Beam schema with beamNo, qualityId, factoryId, expectedMeters, actualMeters, status, machineId
2. POST `/beams` creates beam with status 'created'
3. POST `/beams/:id/load` loads beam on machine and auto-unloads previous beam
4. POST `/beams/:id/unload` manually unloads beam
5. Auto-unload sets previous beam to 'finished' with calculated actualMeters
6. GET `/beams` with status and factory filters

## Tasks / Subtasks

- [ ] Create Beam schema
- [ ] Create Beam service with load/unload logic
- [ ] Implement auto-unload on load
- [ ] Create Beam controller
- [ ] Write unit tests for auto-unload

## Dev Notes

### Beam Schema

```typescript
{
  beamNo: string,         // auto-generated
  qualityId: ObjectId,
  factoryId: ObjectId,
  machineId: ObjectId,    // when loaded
  expectedMeters: number,
  actualMeters: number,
  status: 'created' | 'loaded' | 'finished',
  warperId: ObjectId,
  loadedAt: Date,
  finishedAt: Date
}
```

### Auto-Unload Logic

When loading a new beam on a machine that already has a beam:

1. Find current beam on machine
2. Set current beam status = 'finished'
3. Calculate actualMeters from takas produced
4. Set new beam as loaded

## Testing

- Test beam creation
- Test load updates machine.currentBeamId
- Test auto-unload finishes previous beam

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2026-01-09 | 1.0     | Initial story creation | Architect |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
