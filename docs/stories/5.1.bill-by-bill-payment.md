# Story 5.1: Bill-by-Bill Payment

## Status

Draft

## Story

**As an** accountant,
**I want** to allocate payments to specific invoices,
**so that** I can track bill settlements accurately.

## Acceptance Criteria

1. Payment schema with voucherNo, partyId, amount, mode, allocations
2. GET `/finance/outstanding/:partyId` returns unpaid invoices
3. POST `/payments` with allocations array linking to specific invoices
4. Each allocation updates invoice.paidAmount
5. Invoice status auto-updates (unpaid → partial → paid)
6. Party balance updated on payment
7. Validation: sum of allocations <= payment amount

## Tasks / Subtasks

- [ ] Create Finance module
- [ ] Create Payment schema
- [ ] Create outstanding invoices endpoint
- [ ] Implement payment with allocations
- [ ] Auto-update invoice status
- [ ] Update party balance
- [ ] Write tests

## Dev Notes

### Payment Schema

```typescript
{
  voucherNo: string,
  partyId: ObjectId,
  paymentDate: Date,
  amount: number,
  mode: 'cash' | 'bank' | 'cheque',
  reference: string,      // cheque/UTR number
  allocations: [{
    invoiceId: ObjectId,
    amount: number
  }]
}
```

### Bill-by-Bill Logic

1. Get outstanding invoices for party
2. User selects invoices and amounts
3. Create payment with allocations
4. For each allocation: invoice.paidAmount += allocation.amount
5. If invoice.paidAmount >= invoice.totalAmount → status = 'paid'
6. Update party.currentBalance

## Testing

- Test payment with multiple allocations
- Test invoice status transitions
- Test party balance updates
- Test validation (allocation sum <= payment)

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2026-01-09 | 1.0     | Initial story creation | Architect |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
