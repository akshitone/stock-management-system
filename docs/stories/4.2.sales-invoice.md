# Story 4.2: Sales Invoice

## Status

Draft

## Story

**As an** accountant,
**I want** to create sales invoices with GST,
**so that** I can bill customers and deduct stock.

## Acceptance Criteria

1. Invoice schema with invoiceNo, type, partyId, items (with takaIds), gst, transport, totals
2. POST `/invoices` creates invoice with GST calculation
3. GST auto-calculated: IGST if different state, CGST+SGST if same state
4. **CRITICAL:** Invoice items MUST have both meters AND takas (dual UOM)
5. Stock deducted on invoice creation (emit event)
6. Party balance updated (emit event)
7. GET `/invoices` with party and status filters
8. All endpoints documented in Swagger

## Tasks / Subtasks

- [ ] Create Invoice schema
- [ ] Implement GST calculation logic
- [ ] Enforce dual UOM on invoice items
- [ ] Emit stock deduction event
- [ ] Emit ledger update event
- [ ] Create Invoice controller
- [ ] Write tests

## Dev Notes

### Invoice Schema

```typescript
{
  invoiceNo: string,      // auto-generated
  type: 'sales' | 'purchase' | 'salesReturn',
  partyId: ObjectId,
  orderId: ObjectId,      // optional
  invoiceDate: Date,
  items: [{
    qualityId: ObjectId,
    takaIds: ObjectId[],  // specific takas sold
    meters: number,       // **REQUIRED**
    takas: number,        // **REQUIRED**
    rate: number,
    amount: number
  }],
  gst: {
    cgst: number,
    sgst: number,
    igst: number,
    total: number
  },
  transport: { name, lrNo, freight },
  subtotal: number,
  totalAmount: number,
  paidAmount: number,
  status: 'unpaid' | 'partial' | 'paid'
}
```

### GST Calculation

```typescript
if (party.state === invoicingCompany.state) {
  cgst = subtotal * 0.09;
  sgst = subtotal * 0.09;
} else {
  igst = subtotal * 0.18;
}
```

## Testing

- Test invoice creation
- Test GST calculation for same/different state
- Test dual UOM validation
- Test events emitted

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2026-01-09 | 1.0     | Initial story creation | Architect |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
