# Story 0.2: Database & Auth Setup

## Status

Draft

## Story

**As a** developer,
**I want** JWT authentication and user management configured,
**so that** API endpoints can be protected and users can login.

## Acceptance Criteria

1. User schema created with email, password hash, role fields
2. Password hashing with bcrypt on user creation
3. JWT authentication via Passport.js strategy
4. Login endpoint returns access token
5. Token refresh endpoint available
6. JwtAuthGuard protects all routes except auth endpoints
7. Role-based guard for admin operations
8. Current user endpoint (`/auth/me`) returns user profile
9. Admin user seeded on first run
10. All auth endpoints documented in Swagger

## Tasks / Subtasks

- [ ] Create Auth module structure (AC: 1, 2)
  - [ ] Create `modules/auth/` folder structure
  - [ ] Create User schema with Mongoose
  - [ ] Implement password hashing in pre-save hook
- [ ] Implement JWT strategy (AC: 3, 4)
  - [ ] Install `@nestjs/passport`, `passport-jwt`, `@nestjs/jwt`
  - [ ] Create JWT strategy extending PassportStrategy
  - [ ] Create AuthService with login method
  - [ ] Create AuthController with POST `/auth/login`
- [ ] Implement token refresh (AC: 5)
  - [ ] Add refresh token logic
  - [ ] Create POST `/auth/refresh` endpoint
- [ ] Create guards (AC: 6, 7)
  - [ ] Create JwtAuthGuard
  - [ ] Create RolesGuard with `@Roles()` decorator
  - [ ] Apply JwtAuthGuard globally except for public routes
- [ ] Create profile endpoint (AC: 8)
  - [ ] Add GET `/auth/me` endpoint
  - [ ] Return current user from JWT payload
- [ ] Seed admin user (AC: 9)
  - [ ] Create database seeder script
  - [ ] Add default admin credentials from env
- [ ] Add Swagger documentation (AC: 10)
  - [ ] Add `@ApiTags`, `@ApiOperation` decorators
  - [ ] Configure bearer auth in Swagger

## Dev Notes

### User Schema Structure

```typescript
{
  _id: ObjectId,
  email: string,      // unique, indexed
  password: string,   // bcrypt hashed
  name: string,
  role: 'admin' | 'user',
  isActive: boolean,
  createdAt: Date,
  updatedAt: Date
}
```

### JWT Configuration

- Access token expiry: 1 hour
- Secret: from `JWT_SECRET` env variable
- Algorithm: HS256

### Auth Endpoints

| Method | Endpoint        | Description   | Auth      |
| ------ | --------------- | ------------- | --------- |
| POST   | `/auth/login`   | Login         | Public    |
| POST   | `/auth/refresh` | Refresh token | Public    |
| GET    | `/auth/me`      | Get profile   | Protected |

### Environment Variables

```
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=3600
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=admin123
```

### Dependencies

- `@nestjs/passport`: 10.x
- `@nestjs/jwt`: 10.x
- `passport-jwt`: 4.x
- `bcrypt`: 5.x

## Testing

- Test file location: `apps/api/src/modules/auth/*.spec.ts`
- Test login flow with valid/invalid credentials
- Test protected routes return 401 without token
- Test role guards block non-admin users

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2026-01-09 | 1.0     | Initial story creation | Architect |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
