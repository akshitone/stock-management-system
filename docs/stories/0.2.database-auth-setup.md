# Story 0.2: Database & Auth Setup

## Status

Ready for Review

## Story

**As a** developer,
**I want** JWT authentication and user management configured,
**so that** API endpoints can be protected and users can login.

## Acceptance Criteria

1. User schema created with email, password hash, role fields
2. Password hashing with bcrypt on user creation
3. JWT authentication via Passport.js strategy
4. Login endpoint returns access token
5. Token refresh endpoint available
6. JwtAuthGuard protects all routes except auth endpoints
7. Role-based guard for admin operations
8. Current user endpoint (`/auth/me`) returns user profile
9. Admin user seeded on first run
10. All auth endpoints documented in Swagger

## Tasks / Subtasks

- [x] Create Auth module structure (AC: 1, 2)
  - [x] Create `modules/auth/` folder structure
  - [x] Create User schema with Mongoose
  - [x] Implement password hashing in pre-save hook
- [x] Implement JWT strategy (AC: 3, 4)
  - [x] Dependencies already installed
  - [x] Create JWT strategy extending PassportStrategy
  - [x] Create AuthService with login method
  - [x] Create AuthController with POST `/auth/login`
- [x] Implement token refresh (AC: 5)
  - [x] Add refresh token logic
  - [x] Create POST `/auth/refresh` endpoint
- [x] Create guards (AC: 6, 7)
  - [x] Create JwtAuthGuard
  - [x] Create RolesGuard with `@Roles()` decorator
  - [x] @Public() decorator for public routes
- [x] Create profile endpoint (AC: 8)
  - [x] Add GET `/auth/me` endpoint
  - [x] Return current user from JWT payload
- [x] Seed admin user (AC: 9)
  - [x] Seed on AuthModule.onModuleInit
  - [x] Add default admin credentials in .env.example
- [x] Add Swagger documentation (AC: 10)
  - [x] All endpoints documented
  - [x] Bearer auth configured

## Dev Notes

### User Schema Structure

```typescript
{
  _id: ObjectId,
  email: string,      // unique, indexed
  password: string,   // bcrypt hashed
  name: string,
  role: 'admin' | 'user',
  isActive: boolean,
  createdAt: Date,
  updatedAt: Date
}
```

### JWT Configuration

- Access token expiry: 1 hour
- Secret: from `JWT_SECRET` env variable
- Algorithm: HS256

### Auth Endpoints

| Method | Endpoint        | Description   | Auth      |
| ------ | --------------- | ------------- | --------- |
| POST   | `/auth/login`   | Login         | Public    |
| POST   | `/auth/refresh` | Refresh token | Public    |
| GET    | `/auth/me`      | Get profile   | Protected |

### Environment Variables

```
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=3600
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=admin123
```

### Dependencies

- `@nestjs/passport`: 10.x
- `@nestjs/jwt`: 10.x
- `passport-jwt`: 4.x
- `bcrypt`: 5.x

## Testing

- Test file location: `apps/api/src/modules/auth/*.spec.ts`
- Test login flow with valid/invalid credentials
- Test protected routes return 401 without token
- Test role guards block non-admin users

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2026-01-09 | 1.0     | Initial story creation | Architect |

## Dev Agent Record

### Agent Model Used

Gemini 2.5 Pro (Antigravity / James Dev Agent)

### Debug Log References

- Fixed TypeScript toJSON transform error

### Completion Notes List

- Created Auth module with User schema and bcrypt password hashing
- JWT authentication with configurable expiry
- Login, register, refresh, and profile endpoints
- JwtAuthGuard with @Public() decorator
- RolesGuard with @Roles() decorator
- @CurrentUser() decorator for extracting user
- Admin user seeded on module init

### File List

| Action   | File                                                           |
| -------- | -------------------------------------------------------------- |
| NEW      | apps/api/src/modules/auth/auth.module.ts                       |
| NEW      | apps/api/src/modules/auth/auth.service.ts                      |
| NEW      | apps/api/src/modules/auth/auth.controller.ts                   |
| NEW      | apps/api/src/modules/auth/index.ts                             |
| NEW      | apps/api/src/modules/auth/schemas/user.schema.ts               |
| NEW      | apps/api/src/modules/auth/schemas/index.ts                     |
| NEW      | apps/api/src/modules/auth/dto/auth.dto.ts                      |
| NEW      | apps/api/src/modules/auth/dto/index.ts                         |
| NEW      | apps/api/src/modules/auth/strategies/jwt.strategy.ts           |
| NEW      | apps/api/src/modules/auth/strategies/index.ts                  |
| NEW      | apps/api/src/modules/auth/guards/jwt-auth.guard.ts             |
| NEW      | apps/api/src/modules/auth/guards/roles.guard.ts                |
| NEW      | apps/api/src/modules/auth/guards/index.ts                      |
| NEW      | apps/api/src/modules/auth/decorators/public.decorator.ts       |
| NEW      | apps/api/src/modules/auth/decorators/roles.decorator.ts        |
| NEW      | apps/api/src/modules/auth/decorators/current-user.decorator.ts |
| NEW      | apps/api/src/modules/auth/decorators/index.ts                  |
| MODIFIED | apps/api/src/app.module.ts                                     |
| MODIFIED | apps/api/.env.example                                          |

## QA Results

_To be filled by QA Agent_
